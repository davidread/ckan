this.ckan.module("image-upload",function(i){return{options:{is_url:!1,is_upload:!1,field_upload:"image_upload",field_url:"image_url",field_clear:"clear_upload",field_name:"name",field_query:"query",upload_label:""},_nameIsDirty:!1,initialize:function(){i.proxyAll(this,/_on/);var t=this.options,e='input[name="'+t.field_upload+'"]',l='input[name="'+t.field_url+'"]',s='input[name="'+t.field_clear+'"]',n='input[name="'+t.field_name+'"]',o='textarea[name="'+t.field_query+'"]';this.input=i(e,this.el),this.field_url=i(l,this.el).parents(".control-group"),this.field_image=this.input.parents(".control-group"),this.field_url_input=i("input",this.field_url),this.field_name=this.el.parents("form").find(n),this.label_location=i('label[for="field-image-url"]'),this.is_data_resource="url"===this.options.field_url&&"upload"===this.options.field_upload,this.field_query=i(o).parents(".control-group"),this.field_query_input=i(o)[0],this.field_format=i('input[name="format"]').parents(".control-group");var a=i(s,this.el);a.length>0&&a.parents(".control-group").remove(),this.field_clear=i('<input type="hidden" name="'+t.field_clear+'">').appendTo(this.el);var u=this._("Remove");if(this.field_query_input&&(this.button_query=i('<a href="javascript:;" class="btn"><i class="fa fa-filter"></i>'+this._("Query")+"</a>").prop("title",this._("Query data from other resources")).on("click",this._onQuery).insertAfter(this.input),i('<a href="javascript:;" class="btn btn-danger btn-remove-url" style="top:-1.7em">'+u+"</a>").prop("title",u).on("click",this._onRemove).insertBefore(this.field_query_input),i(this.field_query).on("change",this._onQueryChange)),this.button_url=i('<a href="javascript:;" class="btn"><i class="fa fa-globe"></i>'+this._("Link")+"</a>").prop("title",this._("Link to a URL on the internet (you can also link to an API)")).on("click",this._onFromWeb).insertAfter(this.input),this.button_upload=i('<a href="javascript:;" class="btn"><i class="fa fa-cloud-upload"></i>'+this._("Upload")+"</a>").insertAfter(this.input),i('<a href="javascript:;" class="btn btn-danger btn-remove-url">'+u+"</a>").prop("title",u).on("click",this._onRemove).insertBefore(this.field_url_input),i('label[for="field-image-upload"]').text(t.upload_label||this._("Image")),this.input.on("mouseover",this._onInputMouseOver).on("mouseout",this._onInputMouseOut).on("change",this._onInputChange).prop("title",this._("Upload a file on your computer")).css("width",this.button_upload.outerWidth()),this.fields=i("<i />").add(this.button_upload).add(this.button_url).add(this.input).add(this.field_url).add(this.field_image).add(this.field_query),this.field_name.on("change",this._onModifyName),this.field_name.val()&&(this._nameIsDirty=!0),this.field_query_input&&this.field_query_input.value)this._showOnlyQuery();else if(t.is_url)this._showOnlyFieldUrl(),this._updateUrlLabel(this._("URL"));else if(t.is_upload){this._showOnlyFieldUrl(),this.field_url_input.prop("readonly",!0);var r=this._fileNameFromUpload(this.field_url_input.val());this.field_url_input.val(r),this._updateUrlLabel(this._("File"))}else this._showOnlyButtons()},_fileNameFromUpload:function(i){return i=(i=(i=i.substring(0,-1===i.indexOf("#")?i.length:i.indexOf("#"))).substring(0,-1===i.indexOf("?")?i.length:i.indexOf("?"))).substring(i.lastIndexOf("/")+1,i.length)},_updateUrlLabel:function(i){this.is_data_resource&&this.label_location.text(i)},_onFromWeb:function(){this._showOnlyFieldUrl(),this.field_url_input.focus().on("blur",this._onFromWebBlur),this.options.is_upload&&this.field_clear.val("true"),this._updateUrlLabel(this._("URL"))},_onQuery:function(){this._showOnlyQuery(),this.field_query_input.focus()},_onRemove:function(){this._showOnlyButtons(),this.field_url_input.val(""),this.field_url_input.prop("readonly",!1),this.field_clear.val("true"),this.field_query_input&&(this.field_query_input.value="")},_onInputChange:function(){var i=this.input.val().split(/^C:\\fakepath\\/).pop();this.field_url_input.val(i),this.field_url_input.prop("readonly",!0),this.field_clear.val(""),this._showOnlyFieldUrl(),this._autoName(i),this._updateUrlLabel(this._("File"))},_onQueryChange:function(){this._autoName("Query")},_showOnlyButtons:function(){this.fields.hide(),this.button_upload.add(this.field_image).add(this.button_url).add(this.input).show(),this.field_format.show()},_showOnlyFieldUrl:function(){this.fields.hide(),this.field_url.show(),this.field_format.show()},_showOnlyQuery:function(){this.fields.hide(),this.field_query.show(),this.field_format.hide()},_onInputMouseOver:function(){this.button_upload.addClass("hover")},_onInputMouseOut:function(){this.button_upload.removeClass("hover")},_onModifyName:function(){this._nameIsDirty=!0},_onFromWebBlur:function(){var i=this.field_url_input.val().match(/([^\/]+)\/?$/);i&&this._autoName(i.pop())},_autoName:function(i){this._nameIsDirty||this.field_name.val(i)}}});